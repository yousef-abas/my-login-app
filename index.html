<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OREN - Admin Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root { --bg: #e0e5ec; --primary: #6366f1; --shadow: 9px 9px 16px #babecc, -9px -9px 16px #ffffff; --inner: inset 6px 6px 12px #babecc, inset -6px -6px 12px #ffffff; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #444; }
        .container { max-width: 500px; margin: auto; }
        .card { background: var(--bg); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 12px; font-family: 'Cairo'; outline: none; box-sizing: border-box; background: var(--bg); box-shadow: var(--inner); font-weight: bold; }
        button { box-shadow: var(--shadow); color: var(--primary); font-weight: 900; cursor: pointer; }
        button:active { box-shadow: var(--inner); }
        .task-item { border-right: 5px solid var(--primary); padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 15px; box-shadow: var(--shadow); position: relative; }
        .status-done { border-right-color: #2ecc71; background: #f0fff4; }
        .hidden { display: none; }
        .label { font-size: 12px; color: var(--primary); font-weight: bold; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen" class="card">
        <h2 style="text-align:center">OREN LOGIN</h2>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="admin-screen" class="hidden">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø¯ÙŠØ± ğŸ‘‘</b>
            <button onclick="logout()" style="width:auto; padding:5px 15px; background:#ff4d4d; color:white;">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="card">
            <h3>ØªÙˆØ²ÙŠØ¹ Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ“</h3>
            <span class="label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
            <input type="text" id="cust-name" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
            
            <span class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</span>
            <input type="tel" id="cust-phone" placeholder="010xxxxxxx">
            
            <span class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„</span>
            <input type="text" id="cust-address" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø§Ù„Ø¯ÙˆØ±">
            
            <span class="label">Ø§Ù„Ù…Ø´ÙƒÙ„Ø© / Ø§Ù„Ø·Ù„Ø¨</span>
            <textarea id="cust-issue" placeholder="Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§..."></textarea>
            
            <span class="label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</span>
            <select id="agents-dropdown">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ù‡Ù†Ø§ --</option>
            </select>
            
            <button onclick="assignTask()">Ø¥Ø³Ù†Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ğŸš€</button>
        </div>

        <div id="admin-monitor" class="card">
            <h3>Ù…ØªØ§Ø¨Ø¹Ø© ÙƒØ§ÙØ© Ø§Ù„Ù…Ù‡Ø§Ù… ğŸ“Š</h3>
            <div id="all-tasks-list"></div>
        </div>
    </div>

    <div id="agent-screen" class="hidden">
        <div class="card">
            <h3>Ø£Ù‡Ù„Ø§Ù‹ <span id="agent-name-display"></span> ğŸ‘‹</h3>
            <button onclick="logout()" style="width:auto; background:#ff4d4d; color:white;">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div id="my-tasks" class="card">
            <h3>Ù…Ù‡Ø§Ù…ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</h3>
            <div id="agent-tasks-list"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyALgV2v3lmxvEoP0HosqGSqm727vZrYUq4",
        authDomain: "orenapp-f2f1e.firebaseapp.com",
        databaseURL: "https://orenapp-f2f1e-default-rtdb.firebaseio.com",
        projectId: "orenapp-f2f1e",
        storageBucket: "orenapp-f2f1e.firebasestorage.app",
        messagingSenderId: "973368909449",
        appId: "1:973368909449:web:ce364a309f622f575c3058"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function login() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert("Ø®Ø·Ø£: " + err.message));
    }

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            if (user.email === "admin@oren.com") {
                document.getElementById('admin-screen').classList.remove('hidden');
                fetchAgents(); // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                monitorAll();
            } else {
                document.getElementById('agent-screen').classList.remove('hidden');
                const name = user.email.split('@')[0];
                document.getElementById('agent-name-display').innerText = name;
                loadAgentTasks(name);
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ±
                db.ref('active_agents/' + name).set({ name: name, email: user.email });
            }
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-screen').classList.add('hidden');
            document.getElementById('agent-screen').classList.add('hidden');
        }
    });

    // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    function fetchAgents() {
        db.ref('active_agents').on('value', snap => {
            const dropdown = document.getElementById('agents-dropdown');
            dropdown.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù…Ù† Ù‡Ù†Ø§ --</option>';
            snap.forEach(child => {
                const agent = child.val();
                dropdown.innerHTML += `<option value="${agent.name}">${agent.name}</option>`;
            });
        });
    }

    function assignTask() {
        const name = document.getElementById('cust-name').value;
        const phone = document.getElementById('cust-phone').value;
        const addr = document.getElementById('cust-address').value;
        const issue = document.getElementById('cust-issue').value;
        const agent = document.getElementById('agents-dropdown').value;

        if (!name || !agent) return alert("Ø§Ø®ØªØ§Ø± Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");

        db.ref('tasks_data').push({
            customer: name,
            phone: phone,
            address: addr,
            issue: issue,
            agentName: agent,
            status: "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
            time: new Date().toLocaleString('ar-EG')
        }).then(() => {
            alert("ØªÙ… Ø§Ù„ØªÙƒÙ„ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            document.getElementById('cust-name').value = "";
            document.getElementById('cust-phone').value = "";
            document.getElementById('cust-address').value = "";
            document.getElementById('cust-issue').value = "";
        });
    }

    function loadAgentTasks(myUsername) {
        db.ref('tasks_data').on('value', snap => {
            const list = document.getElementById('agent-tasks-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const t = child.val();
                if (t.agentName === myUsername) {
                    list.innerHTML += `
                        <div class="task-item ${t.status === 'ØªÙ…' ? 'status-done' : ''}">
                            <b>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${t.customer}<br>
                            <b>ğŸ“ Ù‡Ø§ØªÙ:</b> ${t.phone}<br>
                            <b>ğŸ  Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${t.address}<br>
                            <b>ğŸ›  Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:</b> ${t.issue}<br>
                            <hr>
                            ${t.status !== 'ØªÙ…' ? `<button onclick="finishTask('${child.key}')">ØªÙ… Ø§Ù„Ø­Ù„ âœ…</button>` : 'âœ¨ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'}
                        </div>`;
                }
            });
        });
    }

    function finishTask(key) { db.ref('tasks_data/' + key).update({ status: "ØªÙ…" }); }

    function monitorAll() {
        db.ref('tasks_data').on('value', snap => {
            const list = document.getElementById('all-tasks-list');
            list.innerHTML = "";
            snap.forEach(child => {
                const t = child.val();
                list.innerHTML += `
                    <div class="task-item ${t.status === 'ØªÙ…' ? 'status-done' : ''}">
                        <b>ğŸ›µ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨: ${t.agentName}</b><br>
                        <b>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${t.customer} | ${t.status}
                    </div>`;
            });
        });
    }

    function logout() { firebase.auth().signOut(); }
</script>
</body>
</html>
