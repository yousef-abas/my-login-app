<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OREN PRO - Multi-Task System</title>
    <style>
        :root { --p: #9d50bb; --s: #6e48aa; --a: #00d2ff; --bg: #050510; --shadow: rgba(0, 210, 255, 0.3); }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        body { margin: 0; background: var(--bg); color: white; min-height: 100vh; overflow-x: hidden; }

        /* Splash Screen */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .energy-ball { width: 15px; height: 15px; background: #fff; border-radius: 50%; box-shadow: 0 0 20px var(--a); animation: dropAndShock 1.5s forwards; position: absolute; }
        .oren-reveal { font-size: 60px; font-weight: 900; opacity: 0; animation: textReveal 1.2s 1.4s forwards; letter-spacing: 8px; background: linear-gradient(to right, #fff, var(--a)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        @keyframes dropAndShock { 0% { transform: translateY(-800px); } 65% { transform: translateY(0); box-shadow: 0 0 150px 70px rgba(0, 210, 255, 0.6); } 100% { transform: scale(60); opacity: 0; } }
        @keyframes textReveal { 0% { opacity: 0; filter: blur(20px); transform: scale(0.8); } 100% { opacity: 1; filter: blur(0); transform: scale(1); } }

        /* Cards and Inputs */
        .auth-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); padding: 30px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 90%; max-width: 450px; margin: 80px auto; text-align: center; }
        .input-box { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; text-align: center; outline: none; }
        .btn { width: 100%; padding: 18px; border-radius: 15px; border: none; background: linear-gradient(45deg, var(--s), var(--p)); color: white; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .btn:hover { transform: translateY(-3px); filter: brightness(1.1); }

        /* Dashboard */
        #dashboard { display: none; padding: 20px; max-width: 500px; margin: auto; }
        .user-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .counter-badge { background: var(--a); color: var(--bg); padding: 5px 12px; border-radius: 10px; font-weight: 900; }

        /* Task Request */
        .request-card { background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.01)); border-radius: 30px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); margin-bottom: 20px; position: relative; overflow: hidden; }
        .request-card::before { content: ''; position: absolute; top: 0; right: 0; width: 5px; height: 100%; background: var(--a); }
        .client-name { font-size: 24px; font-weight: 900; color: #fff; margin-bottom: 15px; display: block; }
        
        .detail-item { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 15px; margin-bottom: 8px; border-left: 3px solid var(--p); text-align: right; }
        .detail-label { font-size: 10px; opacity: 0.5; display: block; }
        .detail-val { font-size: 14px; font-weight: 600; color: #eee; }

        .report-area { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; color: white; margin-bottom: 15px; height: 80px; resize: none; }
        #waitingMsg { text-align: center; padding: 50px; opacity: 0.5; font-style: italic; }
    </style>
</head>
<body>

    <div id="splash"><div class="energy-ball"></div><div class="oren-reveal">OREN PRO</div></div>

    <div id="authPage">
        <div class="auth-card">
            <h1 style="color: var(--a); margin: 0;">OREN</h1>
            <p style="opacity: 0.5; margin-bottom: 25px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©</p>
            <input type="email" id="lEmail" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="lPass" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn" onclick="login()">Ø¯Ø®ÙˆÙ„ ğŸ”</button>
            <p onclick="showAdmin()" style="margin-top: 20px; font-size: 11px; cursor: pointer; opacity: 0.4;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø¯ÙŠØ±</p>
        </div>
    </div>

    <div id="dashboard">
        <div class="user-bar">
            <div><b id="uName">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</b></div>
            <div class="counter-badge">ØªÙ… Ø¥Ù†Ø¬Ø§Ø²: <span id="uCount">0</span></div>
        </div>

        <div id="taskArea" style="display: none;">
            <div class="request-card">
                <span style="font-size: 10px; color: var(--a); letter-spacing: 1px;">Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© âœ…</span>
                <span class="client-name" id="cName">--</span>
                <div class="detail-item"><span class="detail-label">ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</span><span class="detail-val" id="cAddr">--</span></div>
                <div class="detail-item"><span class="detail-label">ğŸ“ Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†:</span><span class="detail-val" id="cPhone">--</span></div>
                <div class="detail-item"><span class="detail-label">ğŸ“ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</span><span class="detail-val" id="cDesc">--</span></div>
            </div>
            <textarea id="visitReport" class="report-area" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù‡Ù†Ø§..."></textarea>
            <button class="btn" onclick="completeTask()" style="background: linear-gradient(45deg, #00b09b, #96c93d);">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
        </div>

        <div id="waitingMsg">
            <img src="https://cdn-icons-png.flaticon.com/512/5057/5057371.png" width="80" style="opacity: 0.2; filter: invert(1);"><br><br>
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.. Ø§Ø³ØªØ±Ø­ Ù‚Ù„ÙŠÙ„Ø§Ù‹
        </div>
    </div>

    <div id="adminPanel" style="display:none; padding: 20px;">
        <div class="auth-card" style="margin-top: 20px;">
            <h2 style="color: var(--a);">Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© â•</h2>
            <input type="text" id="mUid" class="input-box" placeholder="UID Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨">
            <input type="text" id="mClient" class="input-box" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input type="text" id="mAddress" class="input-box" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
            <input type="text" id="mPhone" class="input-box" placeholder="Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†">
            <textarea id="mDesc" class="input-box" style="height:70px" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©"></textarea>
            <button class="btn" onclick="sendTask()">Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±</button>
            <button onclick="location.reload()" style="background:none; border:none; color:red; margin-top:15px; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, set, get, update, onValue, query, limitToFirst } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALgV2v3lmxvEoP0HosqGSqm727vZrYUq4",
            authDomain: "orenapp-f2f1e.firebaseapp.com",
            databaseURL: "https://orenapp-f2f1e-default-rtdb.firebaseio.com",
            projectId: "orenapp-f2f1e",
            storageBucket: "orenapp-f2f1e.firebasestorage.app",
            messagingSenderId: "973368909449",
            appId: "1:973368909449:web:ce364a309f622f575c3058"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let currentTaskId = null;

        window.login = async () => {
            const e = document.getElementById('lEmail').value;
            const p = document.getElementById('lPass').value;
            try {
                const res = await signInWithEmailAndPassword(auth, e, p);
                currentUser = res.user;
                startApp();
            } catch { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„"); }
        };

        window.showAdmin = () => {
            if(prompt("Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±:") === "123456") {
                document.getElementById('authPage').style.display='none';
                document.getElementById('adminPanel').style.display='block';
            }
        };

        function startApp() {
            document.getElementById('authPage').style.display='none';
            document.getElementById('dashboard').style.display='block';
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙˆÙ„ Ù…Ù‡Ù…Ø© "ØºÙŠØ± Ù…Ù†ØªÙ‡ÙŠØ©" ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            onValue(ref(db, 'tasks/' + currentUser.uid), (snapshot) => {
                const tasks = snapshot.val();
                let found = false;
                if(tasks) {
                    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù‡Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ (Ø§Ù„Ø²Ù…Ù†) ÙˆØ§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯Ø© Ù…Ø´ active: false
                    const keys = Object.keys(tasks).sort(); 
                    for(let key of keys) {
                        if(tasks[key].status === "pending") {
                            showTask(key, tasks[key]);
                            found = true;
                            break;
                        }
                    }
                }
                if(!found) hideTask();
            });

            // Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ®
            onValue(ref(db, 'history/' + currentUser.uid), (snapshot) => {
                document.getElementById('uCount').innerText = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
            });
        }

        function showTask(id, data) {
            currentTaskId = id;
            document.getElementById('cName').innerText = data.client;
            document.getElementById('cAddr').innerText = data.address;
            document.getElementById('cPhone').innerText = data.phone;
            document.getElementById('cDesc').innerText = data.desc;
            document.getElementById('taskArea').style.display = 'block';
            document.getElementById('waitingMsg').style.display = 'none';
        }

        function hideTask() {
            document.getElementById('taskArea').style.display = 'none';
            document.getElementById('waitingMsg').style.display = 'block';
        }

        window.completeTask = async () => {
            const report = document.getElementById('visitReport').value;
            if(!report) return alert("Ø§ÙƒØªØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹");

            // 1. Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„ØªØ§Ø±ÙŠØ®
            const hRef = push(ref(db, 'history/' + currentUser.uid));
            await set(hRef, {
                client: document.getElementById('cName').innerText,
                report: report,
                time: new Date().toLocaleString('ar-EG')
            });

            // 2. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªØµØ¨Ø­ "completed" Ø¹Ø´Ø§Ù† ØªØ®ØªÙÙŠ ÙˆØªØ¸Ù‡Ø± Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡Ø§
            await update(ref(db, 'tasks/' + currentUser.uid + '/' + currentTaskId), { status: "completed" });

            document.getElementById('visitReport').value = "";
            alert("ØªÙ… Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡.. Ø¬Ø§Ø±ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©");
        };

        window.sendTask = async () => {
            const uid = document.getElementById('mUid').value;
            if(!uid) return alert("Ø£Ø¯Ø®Ù„ UID Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… push Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† set Ù„Ø¹Ù…Ù„ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… ÙˆØ±Ø§ Ø¨Ø¹Ø¶Ù‡Ø§
            const newTaskRef = push(ref(db, 'tasks/' + uid));
            await set(newTaskRef, {
                client: document.getElementById('mClient').value,
                address: document.getElementById('mAddress').value,
                phone: document.getElementById('mPhone').value,
                desc: document.getElementById('mDesc').value,
                status: "pending" // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            });
            
            alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø·Ø§Ø¨ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            // Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© ØºÙŠØ±Ù‡Ø§
            document.getElementById('mClient').value = "";
            document.getElementById('mAddress').value = "";
            document.getElementById('mPhone').value = "";
            document.getElementById('mDesc').value = "";
        };

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.opacity='0';
                setTimeout(()=> document.getElementById('splash').style.display='none', 800);
            }, 3000);
        };
    </script>
</body>
</html>
