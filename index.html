<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OREN - User Sync</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        :root { --accent: #00d2ff; --bg: radial-gradient(circle at top right, #1e1e2f, #0d0d1a); }
        * { box-sizing: border-box; transition: 0.3s; font-family: 'Cairo', sans-serif; }
        body { margin: 0; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; color: #fff; padding: 20px; }

        /* Splash Screen */
        #splash { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; z-index: 10000; transition: 0.8s; }
        .loader-text { font-size: 60px; font-weight: 900; letter-spacing: 10px; animation: pulse 1.5s infinite alternate; }
        @keyframes pulse { from { opacity: 0.3; } to { opacity: 1; text-shadow: 0 0 20px var(--accent); } }

        /* Premium Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px);
            border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px; width: 100%; max-width: 480px; box-shadow: 0 40px 100px rgba(0,0,0,0.5);
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        h1 { color: var(--accent); margin: 0 0 15px; text-align: center; font-size: 28px; }
        .input-group { margin-bottom: 12px; text-align: right; }
        label { display: block; font-size: 13px; margin-bottom: 5px; color: var(--accent); font-weight: bold; }
        
        input, textarea {
            width: 100%; padding: 12px 15px; background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; color: #fff; outline: none;
        }

        /* Dropdown Fix - Pure White for Visibility */
        select {
            width: 100%; padding: 14px; border-radius: 15px; border: 2px solid var(--accent);
            background: #ffffff !important; color: #000000 !important;
            font-weight: 900; font-size: 16px; cursor: pointer;
        }

        .main-btn {
            width: 100%; padding: 14px; background: linear-gradient(45deg, #00d2ff, #3a7bd5);
            border: none; border-radius: 15px; color: #fff; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        
        .analysis-box { background: rgba(255,255,255,0.03); border-radius: 20px; padding: 15px; margin-top: 20px; border: 1px dashed rgba(255,255,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="splash"><div class="loader-text">OREN</div></div>

    <div class="glass-card" id="loginUI">
        <h1>OREN</h1>
        <div class="input-group"><input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
        <div class="input-group"><input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>
        <button class="main-btn" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div class="glass-card hidden" id="adminUI">
        <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙˆØ³Ù ğŸ‘‘</h1>
        
        <div class="input-group"><label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input type="text" id="cName"></div>
        <div class="input-group"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="cPhone"></div>
        <div class="input-group">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹):</label>
            <select id="agentSelect"><option value="">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙŠÙˆØ²Ø±Ø²...</option></select>
        </div>
        <div class="input-group"><label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea id="cIssue" rows="2"></textarea></div>
        <button class="main-btn" onclick="assign()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙƒÙ„ÙŠÙ âœ…</button>

        <div class="analysis-box">
            <div style="color: var(--accent); font-weight: bold; margin-bottom: 10px; text-align: center;">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨</div>
            <div id="statsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</div>
        </div>
        
        <p onclick="logout()" style="text-align:center; color:#ff4757; cursor:pointer; margin-top:15px; font-weight:bold;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</p>
    </div>

    <div class="glass-card hidden" id="agentUI">
        <h1 id="agName">Ù…Ù‡Ø§Ù…ÙŠ</h1>
        <div id="tasksList"></div>
        <button class="main-btn" style="background:#444" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALgV2v3lmxvEoP0HosqGSqm727vZrYUq4",
            authDomain: "orenapp-f2f1e.firebaseapp.com",
            databaseURL: "https://orenapp-f2f1e-default-rtdb.firebaseio.com",
            projectId: "orenapp-f2f1e",
            storageBucket: "orenapp-f2f1e.firebasestorage.app",
            messagingSenderId: "973368909449",
            appId: "1:973368909449:web:ce364a309f622f575c3058"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        setTimeout(() => { 
            document.getElementById('splash').style.opacity='0';
            setTimeout(() => document.getElementById('splash').style.display='none', 800);
        }, 2500);

        function login() {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            firebase.auth().signInWithEmailAndPassword(e, p).catch(err => alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"));
        }

        firebase.auth().onAuthStateChanged(user => {
            const l = document.getElementById('loginUI'), d = document.getElementById('adminUI'), a = document.getElementById('agentUI');
            if (user) {
                l.classList.add('hidden');
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ±Ø§Ù‹ Ù„ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¯ÙŠØ±
                const userName = user.email.split('@')[0];
                db.ref('Oren_System_Users/' + userName).set({
                    email: user.email,
                    name: userName,
                    lastSeen: new Date().toLocaleString()
                });

                if (user.email === "admin@oren.com") {
                    d.classList.remove('hidden'); 
                    listenForUsers(); // Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ±Ø§Ù‚Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙˆØ²Ø±Ø²
                    runAnalysis();
                } else {
                    a.classList.remove('hidden');
                    document.getElementById('agName').innerText = "Ø£Ù‡Ù„Ø§Ù‹: " + userName;
                    loadTasks(userName);
                }
            } else {
                l.classList.remove('hidden'); d.classList.add('hidden'); a.classList.add('hidden');
            }
        });

        // Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ‚Ø±Ø£ Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ø³Ø¬Ù„ÙˆØ§ Ø¯Ø®ÙˆÙ„ (Ø§Ù„ÙŠÙˆØ²Ø±Ø² Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª ÙƒØ±ÙŠØªÙ‡Ù…)
        function listenForUsers() {
            db.ref('Oren_System_Users').on('value', snap => {
                const s = document.getElementById('agentSelect');
                s.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ --</option>';
                snap.forEach(c => {
                    const u = c.val();
                    if(u.email !== "admin@oren.com") { // Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                        s.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                    }
                });
            });
        }

        function assign() {
            const ag = document.getElementById('agentSelect').value;
            if(!ag) return alert("Ø§Ø®ØªØ± Ù…Ù†Ø¯ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹");
            db.ref('Oren_Master_Orders').push({
                c: document.getElementById('cName').value,
                p: document.getElementById('cPhone').value,
                i: document.getElementById('cIssue').value,
                to: ag, 
                status: 'pending'
            }).then(() => { 
                alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!");
                document.getElementById('cName').value=""; 
                document.getElementById('cPhone').value="";
                document.getElementById('cIssue').value="";
            });
        }

        function loadTasks(name) {
            db.ref('Oren_Master_Orders').on('value', snap => {
                const list = document.getElementById('tasksList'); list.innerHTML = "";
                snap.forEach(c => {
                    const t = c.val();
                    if(t.to === name && t.status === 'pending') {
                        list.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:20px; margin-bottom:10px; border-right:4px solid var(--accent);">
                            <b style="color:var(--accent)">ğŸ‘¤ ${t.c}</b><br><small>ğŸ“ ${t.p}</small><p>ğŸ“ ${t.i}</p>
                            <button class="main-btn" style="background:#2ed573; padding:8px;" onclick="done('${c.key}')">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ…</button>
                        </div>`;
                    }
                });
            });
        }

        function done(id) { db.ref('Oren_Master_Orders/' + id).update({status: 'done'}); }

        function runAnalysis() {
            db.ref('Oren_Master_Orders').on('value', snap => {
                let stats = {};
                snap.forEach(c => {
                    const t = c.val();
                    if(!stats[t.to]) stats[t.to] = 0;
                    if(t.status === 'done') stats[t.to]++;
                });
                const container = document.getElementById('statsList'); container.innerHTML = "";
                for(let n in stats) {
                    container.innerHTML += `<div class="stat-row"><span>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: ${n}</span><span style="color:#2ed573">Ù…Ù†Ø¬Ø²: ${stats[n]}</span></div>`;
                }
            });
        }

        function logout() { firebase.auth().signOut(); }
    </script>
</body>
</html>
