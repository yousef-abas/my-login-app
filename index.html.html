<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns & Savings</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #f8fafc; 
            background-image: 
                radial-gradient(at 0% 0%, hsla(160, 40%, 10%, 1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(210, 40%, 30%, 1) 0, transparent 50%);
            background-repeat: no-repeat; background-size: 100% 600px;
            min-height: 100vh; color: #334155;
        }
        .card { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 24px; padding: 25px; 
            box-shadow: 0 20px 40px -5px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-3px); }
        
        input, select, textarea {
            background-color: #f8fafc; border: 1px solid #cbd5e1;
            border-radius: 12px; padding: 10px 14px; width: 100%;
            outline: none; transition: all 0.3s; font-size: 0.9rem;
        }
        input:focus, select:focus { border-color: #10b981; background-color: white; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); }
        
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white; padding: 12px; border-radius: 12px; font-weight: 700;
            cursor: pointer; transition: all 0.3s; text-align: center;
        }
        .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .tab-btn { padding: 6px 16px; border-radius: 50px; font-weight: 600; font-size: 0.8rem; }
        .tab-active { background-color: #10b981; color: white; }
        .tab-inactive { color: #64748b; background: #f1f5f9; }

        .high-value { background-color: #fffbeb !important; border-left: 4px solid #f59e0b !important; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #eee !important; }
        }
    </style>
</head>
<body class="pb-20">

    <nav class="w-full pt-6 pb-2 container mx-auto px-6 flex flex-wrap justify-between items-center gap-4 no-print">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center text-2xl border border-white/20">üí∞</div>
            <div class="text-white">
                <h1 class="text-2xl font-bold">Returns & Savings</h1>
                <p class="text-xs opacity-80">Performance Tracking</p>
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button onclick="window.print()" class="bg-blue-600/20 text-blue-100 border border-blue-500/30 px-4 py-2 rounded-xl text-xs font-bold hover:bg-blue-600/40 transition">üñ®Ô∏è Print</button>
            <button onclick="exportCSV()" class="bg-emerald-600/20 text-emerald-100 border border-emerald-500/30 px-4 py-2 rounded-xl text-xs font-bold hover:bg-emerald-600/40 transition">üìä Excel</button>
            <button onclick="exportData()" class="bg-white/10 text-white border border-white/20 px-4 py-2 rounded-xl text-xs font-bold hover:bg-white/20 transition">üíæ Backup</button>
            <button onclick="document.getElementById('fileInput').click()" class="bg-amber-500/20 text-amber-100 border border-amber-500/30 px-4 py-2 rounded-xl text-xs font-bold hover:bg-amber-500/40 transition">üìÇ Restore</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(this)" style="display: none;">
            <button onclick="clearAllData()" class="bg-rose-500/80 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-rose-500">Clear üóëÔ∏è</button>
        </div>
    </nav>

    <div class="container mx-auto px-6 pt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <div class="lg:col-span-3 no-print">
            <div class="card sticky top-8">
                <h2 class="text-lg font-bold mb-5 text-slate-800 border-b pb-3 flex items-center gap-2"><span>üìù</span> Entry Form</h2>
                <form id="dataForm" onsubmit="addEntry(event)" class="space-y-4">
                    <div><label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-widest">Date</label><input type="date" id="date" required></div>
                    <div class="bg-slate-50 p-3 rounded-xl space-y-3 border border-slate-100">
                        <input type="text" id="orderId" placeholder="Order ID" required>
                        <input type="text" id="asin" placeholder="ASIN" required>
                        <input type="number" step="0.01" id="price" placeholder="Price (Savings)" required>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="issue" required>
                            <option value="" disabled selected>Issue...</option>
                            <option value="Fake item">Fake item</option>
                            <option value="Empty box">Empty box</option>
                            <option value="Switch item">Switch item</option>
                            <option value="Broken">Broken</option>
                            <option value="Missing part">Missing part</option>
                            <option value="Over Use">Over Use</option>
                            <option value="Other">Other</option>
                        </select>
                        <select id="road" required>
                            <option value="" disabled selected>Road...</option>
                            <option value="RTN">RTN</option>
                            <option value="RTO">RTO</option>
                        </select>
                    </div>
                    <select id="action">
                        <option value="Refund">Refund</option>
                        <option value="Replacement">Replacement</option>
                        <option value="Return to Inventory">Return to Inventory</option>
                        <option value="Disposal">Disposal</option>
                    </select>
                    <textarea id="comments" rows="2" placeholder="Notes & Comments..."></textarea>
                    <button type="submit" id="saveBtn" class="btn-primary w-full shadow-lg">+ Save Transaction</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-9 space-y-6">
            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-4">
                <div class="card p-4 border-t-4 border-indigo-500"><span class="text-[10px] font-bold text-slate-400 uppercase">Today</span><p class="text-xl font-bold" id="dailyTotal">0</p></div>
                <div class="card p-4 border-t-4 border-emerald-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Month</span>
                    <p class="text-xl font-bold" id="monthlyTotal">0</p>
                    <div id="growthIndicator" class="text-[10px] font-bold mt-1"></div>
                </div>
                <div class="card p-4 border-t-4 border-purple-500"><span class="text-[10px] font-bold text-slate-400 uppercase">Year</span><p class="text-xl font-bold" id="yearlyTotal">0</p></div>
                <div class="card p-4 border-t-4 border-amber-500"><span class="text-[10px] font-bold text-slate-400 uppercase">Avg/Item</span><p class="text-xl font-bold" id="avgSavings">0</p></div>
                <div class="card p-4 border-t-4 border-blue-500"><span class="text-[10px] font-bold text-slate-400 uppercase">Total Items</span><p class="text-xl font-bold" id="totalItems">0</p></div>
                <div class="card p-4 border-t-4 border-rose-500"><span class="text-[10px] font-bold text-slate-400 uppercase">Refund %</span><p class="text-xl font-bold" id="successRate">0%</p></div>
            </div>

            <div class="card">
                <div class="flex justify-between items-center mb-6 no-print">
                    <h3 class="text-lg font-bold text-slate-800">Financial Trends</h3>
                    <div class="bg-slate-100 p-1 rounded-full flex gap-1">
                        <button onclick="switchTimeView('monthly')" id="btn-monthly" class="tab-btn tab-active">Monthly</button>
                        <button onclick="switchTimeView('quarterly')" id="btn-quarterly" class="tab-btn tab-inactive">Quarterly</button>
                    </div>
                </div>
                <div class="h-[300px]"><canvas id="timeChart"></canvas></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card"><h3 class="font-bold mb-4 text-slate-700 text-xs uppercase tracking-widest text-center">Issues</h3><div class="h-[220px]"><canvas id="issueChart"></canvas></div></div>
                <div class="card"><h3 class="font-bold mb-4 text-slate-700 text-xs uppercase tracking-widest text-center">Return Road</h3><div class="h-[220px]"><canvas id="roadChart"></canvas></div></div>
                <div class="card"><h3 class="font-bold mb-4 text-slate-700 text-xs uppercase tracking-widest text-center">Actions</h3><div class="h-[220px]"><canvas id="actionChart"></canvas></div></div>
            </div>

            <div class="card p-0 overflow-hidden">
                <div class="p-5 border-b bg-white flex flex-wrap justify-between items-center gap-4 no-print">
                    <h3 class="font-bold text-slate-800">Transaction History</h3>
                    <div class="relative w-full md:w-64">
                        <input type="text" id="tableSearch" onkeyup="renderTable()" placeholder="Search Order or ASIN..." class="pl-4 py-2 text-xs">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                            <tr><th class="p-4">Date</th><th class="p-4">Order / ASIN</th><th class="p-4">Issue</th><th class="p-4">Road</th><th class="p-4 text-right">Savings</th><th class="p-4 text-center no-print">X</th></tr>
                        </thead>
                        <tbody id="dataTableBody" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let entries = [];
        try { const saved = localStorage.getItem('returnsData_pro_v3'); if(saved) entries = JSON.parse(saved); } catch(e) { entries = []; }

        let charts = {};
        let currentTimeView = 'monthly';
        document.getElementById('date').valueAsDate = new Date();

        function addEntry(e) {
            e.preventDefault();
            const entry = {
                id: Date.now(),
                date: document.getElementById('date').value,
                orderId: document.getElementById('orderId').value.trim(),
                asin: document.getElementById('asin').value.trim().toUpperCase(),
                price: parseFloat(document.getElementById('price').value),
                issue: document.getElementById('issue').value,
                road: document.getElementById('road').value,
                action: document.getElementById('action').value,
                comments: document.getElementById('comments').value
            };
            entries.push(entry);
            saveData(); updateUI(); e.target.reset();
            document.getElementById('date').valueAsDate = new Date();
        }

        function saveData() { localStorage.setItem('returnsData_pro_v3', JSON.stringify(entries)); }
        function formatNumber(num) { return Number(num).toLocaleString(undefined, { maximumFractionDigits: 2 }); }

        function updateUI() {
            const now = new Date();
            const curMonth = now.getMonth();
            const curYear = now.getFullYear();
            const lastMonth = curMonth === 0 ? 11 : curMonth - 1;
            const lastMonthYear = curMonth === 0 ? curYear - 1 : curYear;
            const todayStr = now.toISOString().split('T')[0];
            
            let d=0, m=0, lastM=0, y=0, total=0, refunds=0;
            
            entries.forEach(e => {
                const ed = new Date(e.date);
                total += e.price;
                if(e.date === todayStr) d += e.price;
                if(ed.getFullYear() === curYear) {
                    y += e.price;
                    if(ed.getMonth() === curMonth) m += e.price;
                }
                if(ed.getFullYear() === lastMonthYear && ed.getMonth() === lastMonth) lastM += e.price;
                if(e.action === 'Refund') refunds++;
            });

            const growthInd = document.getElementById('growthIndicator');
            if(lastM > 0) {
                const growth = ((m - lastM) / lastM) * 100;
                const color = growth >= 0 ? 'text-emerald-500' : 'text-rose-500';
                const sign = growth >= 0 ? '‚Üë' : '‚Üì';
                growthInd.innerHTML = `<span class="${color}">${sign} ${Math.abs(Math.round(growth))}% vs last month</span>`;
            } else { growthInd.innerHTML = `<span class="text-slate-300">Ready</span>`; }

            document.getElementById('dailyTotal').innerText = formatNumber(d);
            document.getElementById('monthlyTotal').innerText = formatNumber(m);
            document.getElementById('yearlyTotal').innerText = formatNumber(y);
            document.getElementById('totalItems').innerText = entries.length;
            document.getElementById('avgSavings').innerText = entries.length ? formatNumber(total / entries.length) : 0;
            document.getElementById('successRate').innerText = entries.length ? Math.round((refunds/entries.length)*100) + '%' : '0%';

            renderTable();
            renderCharts();
        }

        function renderTable() {
            const searchTerm = (document.getElementById('tableSearch')?.value || "").toLowerCase();
            const tbody = document.getElementById('dataTableBody'); tbody.innerHTML = '';
            
            entries.slice().reverse().slice(0,25).forEach(e => {
                if(!e.orderId.toLowerCase().includes(searchTerm) && !e.asin.toLowerCase().includes(searchTerm)) return;

                const isHighValue = e.price > 1000;
                const badge = e.road==='RTO' 
                    ? `<span class="bg-rose-50 text-rose-600 py-1 px-2 rounded text-[10px] font-bold border border-rose-100">RTO</span>` 
                    : `<span class="bg-emerald-50 text-emerald-600 py-1 px-2 rounded text-[10px] font-bold border border-emerald-100">RTN</span>`;
                
                tbody.innerHTML += `
                    <tr class="${isHighValue ? 'high-value' : ''} hover:bg-slate-50 transition-colors">
                        <td class="p-4 text-[10px] text-slate-400 font-mono">${e.date}</td>
                        <td class="p-4">
                            <div class="font-bold text-slate-700 text-xs">${e.orderId}</div>
                            <div class="text-[9px] text-indigo-500 font-bold">${e.asin}</div>
                        </td>
                        <td class="p-4 text-xs">${e.issue} ${e.comments ? 'üí¨' : ''}</td>
                        <td class="p-4">${badge}</td>
                        <td class="p-4 text-right font-bold ${isHighValue ? 'text-amber-600' : 'text-emerald-600'} text-xs">
                            ${isHighValue ? 'üî• ' : ''}+${formatNumber(e.price)}
                        </td>
                        <td class="p-4 text-center no-print"><button onclick="deleteEntry(${e.id})" class="text-rose-300 hover:text-rose-500">‚úï</button></td>
                    </tr>`;
            });
        }

        function renderCharts() {
            const curY = new Date().getFullYear();
            const timeLabels = currentTimeView === 'monthly' ? ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] : ['Q1','Q2','Q3','Q4'];
            const timeData = currentTimeView === 'monthly' ? Array(12).fill(0) : Array(4).fill(0);
            
            entries.forEach(e => {
                const ed = new Date(e.date);
                if(ed.getFullYear() === curY) {
                    const idx = currentTimeView === 'monthly' ? ed.getMonth() : Math.floor(ed.getMonth()/3);
                    timeData[idx] += e.price;
                }
            });

            if(charts.time) charts.time.destroy();
            charts.time = new Chart(document.getElementById('timeChart'), { type: 'line', data: { labels: timeLabels, datasets: [{ data: timeData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', fill: true, tension: 0.4, borderWidth: 3 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            // ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ŸÑÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ™ÿ¨ŸàŸäŸÅ ÿßŸÑÿØÿßÿÆŸÑŸä (Pie Chart)
            const renderPie = (id, key, colors) => {
                const counts = {}; entries.forEach(e => counts[e[key]] = (counts[e[key]]||0)+1);
                if(charts[id]) charts[id].destroy();
                charts[id] = new Chart(document.getElementById(id), { 
                    type: 'pie', // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸàÿπ ŸÖŸÜ doughnut ÿ•ŸÑŸâ pie
                    data: { 
                        labels: Object.keys(counts), 
                        datasets: [{ 
                            data: Object.values(counts), 
                            backgroundColor: colors, 
                            hoverOffset: 15,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }] 
                    }, 
                    options: { 
                        maintainAspectRatio: false, 
                        // ÿ™ŸÖ ÿ¨ÿπŸÑ cutout ÿ®ÿµŸÅÿ± ŸÑÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ÿ™ŸÖÿßŸÖÿßŸã
                        cutout: 0, 
                        plugins: { 
                            legend: { 
                                position: 'bottom', 
                                labels: { boxWidth: 10, padding: 15, font: { size: 10, weight: 'bold' } } 
                            } 
                        } 
                    } 
                });
            };

            renderPie('issueChart', 'issue', ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#8b5cf6']);
            renderPie('roadChart', 'road', ['#10b981', '#f43f5e']);
            renderPie('actionChart', 'action', ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b']);
        }

        function deleteEntry(id) { if(confirm('Delete?')) { entries = entries.filter(e => e.id !== id); saveData(); updateUI(); } }
        function clearAllData() { if(confirm('Clear ALL?')) { entries = []; saveData(); updateUI(); } }
        function switchTimeView(v) { currentTimeView = v; ['monthly','quarterly'].forEach(id => document.getElementById('btn-'+id).className = (id===v)?'tab-btn tab-active':'tab-btn tab-inactive'); renderCharts(); }
        
        function exportCSV() {
            let csv = "Date,Order ID,ASIN,Price,Issue,Road,Action\n";
            entries.forEach(e => csv += `${e.date},${e.orderId},${e.asin},${e.price},${e.issue},${e.road},${e.action}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Returns_Report.csv'; a.click();
        }
        function exportData() {
            const blob = new Blob([JSON.stringify(entries)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Data_Backup.json'; a.click();
        }
        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => { 
                try { 
                    const imported = JSON.parse(e.target.result); 
                    if(Array.isArray(imported)) {
                        entries = imported; 
                        saveData(); 
                        updateUI(); 
                        alert("Data restored successfully! ‚úÖ");
                    }
                } catch(e){ alert("Error: Invalid file format."); } 
            };
            reader.readAsText(input.files[0]);
        }

        updateUI();
    </script>
</body>
</html>